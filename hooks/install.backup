#!/usr/bin/python

import setup
setup.pre_install()
import os
import subprocess
from subprocess import Popen

from charmhelpers.core import hookenv, fetch


def install():
    hookenv.log('Installing ceph-dash')
    hookenv.log('Installing nginx dependency')
    fetch.apt_install(fetch.filter_installed_packages(['nginx', 'python-ceph', 'build-essential', 'python-dev', 'pip']))
    fetch.add_source('ppa:xfactor973/ceph')
    fetch.apt_update()

    # Installs ceph-dash to /opt/ceph-dash
    fetch.apt_install(fetch.filter_installed_packages(['ceph-dash']))
    hookenv.log('Installing uwsgi dependency')
    subprocess.Popen('pip install uwsgi', shell=True)

    os.mkdir('/var/log/uwsgi')
    os.rm('/etc/nginx/sites-enabled/default')
    os.symlink('/etc/nginx/sites-available/cephdash.conf',
        '/etc/nginx/sites-enabled/cephdash.conf')

if __name__ == "__main__":
    install()
